<% a = 0 %>
<%= link_to image_tag("/images/icons/add.png", :title => "Inserir")+" Enviar Arquivo", new_frequencia_frequencia_path %><br /><br />
<table class="grid">
  <tr class="grid_title">
    <td colspan="6">Lista de Frequências de <%= current_usuario.nome %></td>
  </tr>
  <%= form_for(:filtro, :method => 'post', :url => {:action => 'index'}) do |f| %>

  <tr>
	    <td class="grid_label center">Filtro</td>
	    <td colspan="4" class="grid_action form_filter">

        <div class="input_container">
          <%= f.label :data %>
          <%= f.date_select :data,
                          :start_year => Date.current.year,
                          :end_year => 2000,
                          :order => [:day, :month, :year],
                          :prompt => { :day => 'Dia', :month => 'Mês', :year => 'Ano' }
          %>
        </div>
  </td>
	    <td class="grid_action center">
		<input type="submit" value="Filtrar" name="filter" id="filter">	    </td>
	</tr>
  <% end %>
  <tr>
    <td class="grid_label center">Data</td>
    <td class="grid_label center">Usuário</td>
    <td class="grid_label center">Matricula</td>

    <% @frequencias.each do |s| %>
        <% if @datas[0].to_s_br == s.data.strftime("%d/%m/%Y") %>
            <td class="grid_label center"><%= "Hora #{a +=1}" %></td>
        <% end %>
    <% end %>

    <td class="grid_label center">Total Geral</td>
  </tr>
<% @datas.each do |ponto| %>
  <tr>
    <%
       q = 0
       total = 0
    %>
     <td class="grid_value center"><%= ponto.strftime("%d/%m/%Y") %></td>
     <td class="grid_value center"><%= (current_usuario.nome.nil?)? '-' : current_usuario.nome %></td>
     <td class="grid_value center"><%= current_usuario.matricula %></td>
    <% @frequencias.each do |z| %>
        <% if ponto.to_s_br == z.data.strftime("%d/%m/%Y") %>
            <td class="grid_value center"><%= z.data.strftime("%H:%M") %></td>
            <% total = ChronicDuration.parse(z.data.strftime("%H:%M")) - total  %>
        <% elsif q <= 1 and (ponto.to_s_br != z.data.strftime("%d/%m/%Y"))  %>
            <% q +=1 %>
            <td class="grid_value center"> - </td>
        <% end %>
    <% end %>
     <td class="grid_value center">
       <% if total > 0 %>
         <%= ChronicDuration.output(total, :format => :chrono) %>
       <% else %>
         Inconsistente
       <% end %>
     </td>
  </tr>
<% end %>
  <tr>
    <td class="grid_footer" colspan="6"><%= raw "<strong>Total:</strong> #{@total}" %></td>
  </tr>
</table>